---
title: "cluster_analysis"
author: Rebecca J. Salamon
output: rds object
date: "2025-08-28"
---

```{r setup, include=FALSE}
library(Seurat)
library(ggplot2)
library(dplyr)
library(writexl)     # for xlsx export
library(org.Mm.eg.db)  # gene → full name lookup (Bioconductor)
library(openxlsx)
library(tidyr)
library(ggplot2)
library(data.table)
library(RSQLite)
library(clusterProfiler)  # should now load without error
library(tibble)
library(ReactomePA)
library(fgsea)
library(msigdbr)
library(enrichplot)
library(DT)
library(stringr)
setwd("/Users/beckysalamon/Desktop/saline-6ohda-scrna-seq/data-images")
```

## R Markdown

```{r cars}
library(Seurat)

merged_obj <- readRDS("/Users/beckysalamon/Desktop/saline-6ohda-scrna-seq/RDS_object/seurat_obj_harmony_integrated_res0.2.rds")

# Optional safety checks
DefaultAssay(merged_obj)        # Should return "SCT"
table(Idents(merged_obj))       # View cluster distribution
head(merged_obj@meta.data)      # Confirm metadata looks correct

Idents(merged_obj) <- merged_obj$SCT_snn_res.0.2  

# Set the correct resolution (e.g., resolution = 0.2)
Idents(merged_obj) <- merged_obj$SCT_snn_res.0.2

DimPlot(merged_obj, label = TRUE)

"SCT_snn_res.0.2" %in% colnames(merged_obj@meta.data)


```
#Map subsets based on key genes 

```{r pressure, echo=FALSE}
# Set correct levels for condition
merged_obj$orig.ident <- factor(merged_obj$orig.ident, levels = c("saline", "6OHDA"))

# Define marker genes
genes_of_interest <- c(
  "Col1a1",  # mes
  "Col3a1",  # mes
  "Epcam",   # epi
  "Cdh1",    # epi
  "Ptprc",   # immune
  "Cldn5",   # endo
  "Pecam1"   # endo
)

# Create split UMAP plots by condition
plot_list <- list()
for (gene in genes_of_interest) {
  plot_list[[gene]] <- FeaturePlot(
    merged_obj,
    features = gene,
    reduction = "umap",
    split.by = "orig.ident",
    cols = c("lightgrey", "firebrick"),
    label = TRUE,
    label.size = 3,
    pt.size = 1
  ) +
    ggtitle(paste("Expression of", gene)) +
    theme_minimal()
}
# Display plots
for (gene in genes_of_interest) {
  print(plot_list[[gene]])
}
```

#Set compartment identities 

```{r pressure, echo=FALSE}
# Set identities
Idents(merged_obj) <- "seurat_clusters"

# Define cluster groupings by expression pattern
mesenchymal_clusters <- c(2)
epithelial_clusters  <- c(5, 6, 10, 17, 19)
endothelial_clusters <- c(0, 7, 8, 12, 16)
immune_clusters      <- c(1, 3, 4, 9, 11, 13, 14, 15, 18, 20)

# Assign new compartment label
merged_obj$compartment <- NA
merged_obj$compartment[merged_obj$seurat_clusters %in% mesenchymal_clusters] <- "Mesenchymal"
merged_obj$compartment[merged_obj$seurat_clusters %in% epithelial_clusters]  <- "Epithelial"
merged_obj$compartment[merged_obj$seurat_clusters %in% endothelial_clusters] <- "Endothelial"
merged_obj$compartment[merged_obj$seurat_clusters %in% immune_clusters]      <- "Immune"
merged_obj$compartment <- factor(merged_obj$compartment, 
                                 levels = c("Mesenchymal", "Epithelial", "Endothelial", "Immune"))

# Subset each compartment
mesenchymal_obj <- subset(merged_obj, idents = mesenchymal_clusters)
epithelial_obj  <- subset(merged_obj, idents = epithelial_clusters)
endothelial_obj <- subset(merged_obj, idents = endothelial_clusters)
immune_obj      <- subset(merged_obj, idents = immune_clusters)

# Compartment-colored UMAP
DimPlot(
  merged_obj,
  group.by = "compartment",
  reduction = "umap",
  label = FALSE,
  repel = TRUE
) +
  scale_color_manual(values = c(
    "Mesenchymal" = "#00A7C7",
    "Epithelial"  = "#E69F00",
    "Endothelial" = "#1B9E77",
    "Immune"      = "#E7298A"
  )) +
  ggtitle("Cell Compartments") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),            # remove grey grid lines
    axis.line = element_line(linewidth = 0.5, colour = "black"), # draw x/y axes
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold")
  )

# Tabulate compartment counts by condition
compartment_counts <- table(merged_obj$compartment, merged_obj$orig.ident)
compartment_counts_df <- as.data.frame.matrix(compartment_counts)

# Print counts
print(compartment_counts_df)

# Optional for reporting
knitr::kable(compartment_counts_df, caption = "Cell counts per compartment per condition")
```
# Compartment-colored UMAP
DimPlot(
  merged_obj,
  group.by = "compartment",
  reduction = "umap",
  label = FALSE,
  repel = TRUE
) +
  scale_color_manual(values = c(
    "Mesenchymal" = "#00A7C7",
    "Epithelial"  = "#E69F00",
    "Endothelial" = "#1B9E77",
    "Immune"      = "#E7298A"
  )) +
  ggtitle("Compartments") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),            # remove grey grid lines
    axis.line = element_line(linewidth = 0.5, colour = "black"), # draw x/y axes
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold")
  )


# Identify SOUP-like genes
```{r pressure, echo=FALSE}

DefaultAssay(merged_obj) <- "SCT"
Idents(merged_obj) <- "seurat_clusters"

# Average expression per cluster
cluster_avg <- AverageExpression(
  merged_obj,
  return.seurat = FALSE,
  assays = "SCT",
  slot = "data"
)

expr_mat <- cluster_avg$SCT

# Ensure rownames
if (is.null(rownames(expr_mat))) {
  rownames(expr_mat) <- rownames(merged_obj[["SCT"]])
}

# Soup metric: number of clusters where expression > threshold
gene_cluster_counts <- rowSums(expr_mat > 0.5)

soup_gene_table <- data.frame(
  gene                  = rownames(expr_mat),
  num_clusters_expressed = gene_cluster_counts,
  pct_clusters_expressed = 100 * gene_cluster_counts / ncol(expr_mat),
  is_soup_like           = (100 * gene_cluster_counts / ncol(expr_mat)) > 80
)

# Extract names of soup-like genes
soup_genes <- soup_gene_table$gene[soup_gene_table$is_soup_like]

# Number of soup genes
num_soup_removed <- length(soup_genes)
cat("✔ Identified", num_soup_removed, "soup-like genes.\n")

# OPTIONAL: remove soup genes from the expression matrix
expr_mat_clean <- expr_mat[!rownames(expr_mat) %in% soup_genes, ]

cat("✔ Expression matrix filtered: ",
    nrow(expr_mat) - nrow(expr_mat_clean),
    "genes removed.\n")

# Show top soup genes
head(
  soup_gene_table[order(-soup_gene_table$pct_clusters_expressed), ],
  10
)

```
## Save new object  

```{r pressure, echo=FALSE}
# Save Seurat object to file
saveRDS(merged_obj, file = "/Users/beckysalamon/Desktop/saline-6ohda-scrna-seq/RDS_object/seurat_obj_4_comp_cluster_subset.rds")
```


library(Cairo)
library(Seurat)
library(ggplot2)

# Example: Create a UMAP DimPlot
p <- DimPlot(seurat_obj, reduction = "umap", label = TRUE) + 
  # Optionally start with DarkTheme for white text, then override backgrounds:
  DarkTheme() + 
  # Override theme elements for transparency and white text:
  theme(
    plot.background = element_rect(fill = "transparent", color = NA),   # transparent plot background:contentReference[oaicite:4]{index=4}
    panel.background = element_rect(fill = "transparent", color = NA),  # transparent panel background
    legend.background = element_rect(fill = "transparent", color = NA), # transparent legend background
    legend.box.background = element_rect(fill = "transparent", color = NA), # transparent legend container
    legend.key = element_rect(fill = "transparent", color = NA),       # transparent legend key (no fill):contentReference[oaicite:5]{index=5}
    panel.grid.major = element_blank(),   # remove major grid lines:contentReference[oaicite:6]{index=6}
    panel.grid.minor = element_blank(),   # remove minor grid lines
    axis.text = element_text(color = "white"),   # axis tick labels in white
    axis.title = element_text(color = "white"),  # axis titles in white
    axis.ticks = element_line(color = "white"),  # axis ticks in white
    axis.line = element_line(color = "white"),   # axis lines in white (if present)
    plot.title = element_text(color = "white"),  # plot title in white (if title added)
    legend.title = element_text(color = "white"),
    legend.text = element_text(color = "white")
  )


# Save the plot as a PNG with transparent background
ggsave(
  filename = "plot_transparent.svg",
  plot = p,  # your ggplot or Seurat plot
  device = "svg",
  width = 6,
  height = 5
)


#check comaprtment counts 
compartment_counts

# Make sure these are in your metadata
table(merged_obj$compartment, merged_obj$orig.ident)

# Or use dplyr for a clean summary table
compartment_counts <- merged_obj@meta.data %>%
  count(orig.ident, compartment) %>%
  tidyr::pivot_wider(names_from = orig.ident, values_from = n, values_fill = 0)

compartment_counts

# UMAP colored by broad compartments and split salie vs 6OHDA
DimPlot(merged_obj, group.by = "compartment", reduction = "umap") +
  ggtitle("Cell Compartments")
  
 DimPlot(merged_obj, 
        group.by = "compartment", 
        reduction = "umap", 
        split.by = "orig.ident") +
  ggtitle("Cell Compartments by Sample (res 1.5)")

# 7. Plot saline vs 6OHDA overlay 
DimPlot(merged_obj, group.by = "Method", reduction = "umap", label = FALSE)



