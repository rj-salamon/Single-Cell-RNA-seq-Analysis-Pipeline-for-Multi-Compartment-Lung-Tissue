---
title: "cluster_analysis"
author: "Rebecca J. Salamon"
date: "2025-08-26"
output: html_document
---

```{r setup, include=FALSE}
library(Seurat)
library(ggplot2)
library(dplyr)
library(writexl)   
library(org.Mm.eg.db)  
library(openxlsx)
library(tidyr)
library(ggplot2)
library(data.table)
library(RSQLite)
library(clusterProfiler) 
library(tibble)
library(ReactomePA)
library(fgsea)
library(msigdbr)
library(enrichplot)
library(DT)
library(stringr)
library(pheatmap)
library(ggrepel)

setwd("/Users/beckysalamon/Desktop/saline-6ohda-scrna-seq/data-images")
```

## Open cluster subset RDS file

```{r}
library(Seurat)

merged_obj <- readRDS("/Users/beckysalamon/Desktop/saline-6ohda-scrna-seq/RDS_object/seurat_obj_4_comp_cluster_subset.rds")

# Compartment-colored UMAP
DimPlot(
  merged_obj,
  group.by = "compartment",
  reduction = "umap",
  label = FALSE,
  repel = TRUE
) +
  scale_color_manual(values = c(
    "Mesenchymal" = "#00A7C7",
    "Epithelial"  = "#E69F00",
    "Endothelial" = "#1B9E77",
    "Immune"      = "#E7298A"
  )) +
  ggtitle("Compartments") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),            # remove grey grid lines
    axis.line = element_line(linewidth = 0.5, colour = "black"), # draw x/y axes
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold")
  )
```
#Subset to Mesenchymal

```{r}

# Subset to Mesenchymal
mesenchymal_obj <- subset(merged_obj, subset = compartment == "Mesenchymal")

# Keep cluster ids handy
mesenchymal_obj$mes_cluster <- Idents(mesenchymal_obj)

# ---- set condition variables EARLY ----
mesenchymal_obj$orig.ident <- factor(mesenchymal_obj$orig.ident, levels = c("saline", "6OHDA"))

mesenchymal_obj$Treatment <- dplyr::case_when(
  mesenchymal_obj$orig.ident %in% c("Saline", "saline", "Saline_rep") ~ "Saline",
  mesenchymal_obj$orig.ident %in% c("6OHDA", "6ohda", "6OHDA_rep")    ~ "6OHDA",
  TRUE ~ NA_character_
)
mesenchymal_obj$Treatment <- factor(mesenchymal_obj$Treatment, levels = c("Saline", "6OHDA"))
# ---------------------------------------

# Now it‚Äôs safe to compute tables/plots
print(table(mesenchymal_obj$mes_cluster, mesenchymal_obj$orig.ident))

DimPlot(mesenchymal_obj, group.by = "orig.ident", reduction = "umap")

as.data.frame(table(mesenchymal_obj$mes_cluster, mesenchymal_obj$orig.ident)) %>%
  ggplot(aes(Var1, Freq, fill = Var2)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Cluster", y = "Cell Count", fill = "Condition") +
  theme_minimal() +
  ggtitle("Cell Count per Cluster by Condition") +
  coord_flip()



```

## Re-cluster the subset

```{r}
#save original cluster identities for comparision later 
mesenchymal_obj$original_cluster <- mesenchymal_obj$seurat_clusters

# Re-cluster the subset
DefaultAssay(mesenchymal_obj) <- "SCT"

# Rerun SCTransform on the mesenchymal-only, balanced cells
mesenchymal_obj <- SCTransform(mesenchymal_obj, 
                               method = "glmGamPoi", 
                               variable.features.n = 3000, 
                               conserve.memory = TRUE, 
                               verbose = FALSE)

mesenchymal_obj <- mesenchymal_obj |>
  RunPCA(npcs = 50, verbose = FALSE) |>
  FindNeighbors(dims = 1:30) |>
  FindClusters(resolution = 0.4) |> #fine tune based on clustering, aiming for 10-20 populations typically 
  RunUMAP(dims = 1:30)

# Set new identity class 
Idents(mesenchymal_obj) <- mesenchymal_obj$seurat_clusters

# Optional: relabel for clarity (e.g., Mes_4, Mes_1, ...)
mesenchymal_obj$mes_cluster <- paste0("Mes_", mesenchymal_obj$seurat_clusters)
Idents(mesenchymal_obj) <- mesenchymal_obj$mes_cluster

```


# Create feature plots for each gene 

```{r}
# Set the correct factor levels for orig.ident
mesenchymal_obj$orig.ident <- factor(mesenchymal_obj$orig.ident, levels = c("saline", "6OHDA"))

# Define the genes of interest
genes_of_interest <- c("Scube2", "Tcf21", "Cthrc1", "Taco1", "Fth1", "Pi16", "Saa3", "Lcn2", "Cxcl13", "Tek", "Hhip", "Msln", "Myh11", "Adra1a", "Ccl2", "Cox4i2", "Dcn")

# Create feature plots for each gene with split by 'orig.ident' (condition)
plot_list <- list()  # List to store plots

# Initialize list to store plots
plot_list <- list()

# Generate plots
for (gene in genes_of_interest) {
  plot_list[[gene]] <- FeaturePlot(
    mesenchymal_obj, 
    features = gene, 
    reduction = "umap", 
    cols = c("lightgrey", "blue"),  # Color scheme
    label = TRUE,  
    label.size = 3,  
    pt.size = 1  
  ) + ggtitle(paste(gene))
}

# Display the plots
for (gene in genes_of_interest) {
  print(plot_list[[gene]])
}

```

# Display the plots
for (gene in genes_of_interest) {
  print(plot_list[[gene]])
}

#compare old vs new clusters
DimPlot(mesenchymal_obj, group.by = "original_cluster", label = TRUE)
DimPlot(mesenchymal_obj, group.by = "seurat_clusters", label = TRUE)

# UMAP colored by reclustered identities (Mes_4, Mes_1, etc.)
DimPlot(mesenchymal_obj, 
        reduction = "umap", 
        group.by = "mes_cluster", 
        label = FALSE, 
        label.size = 4) + 
  ggtitle("Reclustered Mesenchymal Cells (UMAP)") +
  theme_minimal()

# UMAP split by condition
DimPlot(
  mesenchymal_obj, 
  reduction = "umap", 
  group.by = "mes_cluster", 
  split.by = "orig.ident", 
  label = TRUE, 
  label.size = 3, 
  pt.size = 1.0  # <- Increase point size
) +
  ggtitle("Reclustered Mesenchymal Cells by Condition") +
  theme_minimal()

## Identify cluster markers

```{r}

# --- 3. Identify cluster markers -------------------------------------------

mesenchymal_obj <- PrepSCTFindMarkers(mesenchymal_obj)


all_markers <- FindAllMarkers(
  mesenchymal_obj,
  assay = "SCT",
  slot = "data",
  only.pos = TRUE,
  min.pct = 0.25,
  logfc.threshold = 0.25
)


# Top-50 genes per cluster
top_markers <- all_markers |>
  group_by(cluster) |>
  slice_max(order_by = avg_log2FC, n = 50, with_ties = FALSE)

```
## Write Excel for top markers per cluster 

```{r}
library(openxlsx)
library(dplyr)

# Create workbook for top markers per cluster
wb1 <- createWorkbook()

# Loop over clusters
clusters <- unique(top_markers$cluster)

for (clust in clusters) {
  df <- top_markers %>%
    filter(cluster == clust) %>%
    arrange(desc(avg_log2FC)) %>%
    mutate(compartment = "Mesenchymal")
  
  sheet_name <- substr(paste0("Cluster_", clust), 1, 31)  # Excel sheet name limit
  addWorksheet(wb1, sheet_name)
  writeData(wb1, sheet = sheet_name, df)
}

# Save workbook
saveWorkbook(wb1, "/Users/beckysalamon/Desktop/saline-6ohda-scrna-seq/excel/mesenchymal_top_markers_by_cluster.xlsx", overwrite = TRUE)

```

## Lable clusters

```{r}
# Define annotations for each cluster
cluster_annotations <- data.frame(
  ClusterID   = paste0("Mes_", 0:10),
  Compartment = rep("Mesenchymal", 11),
  Identity    = c("Alveolar", "Fibrotic", "Transitional-Myofib", "Stress-activated",
                  "Adventitial", "Inflammatory", "Adventitial-Immune", "Perivascular",
                  "Peribronchial", "Mesothelial", "Pericyte")
)


# Assign Compartment identity to metadata
mesenchymal_obj$Compartment <- cluster_annotations$Identity[
  match(mesenchymal_obj$mes_cluster, cluster_annotations$ClusterID)
]


# Verify the new Identify column
head(mesenchymal_obj@meta.data)
table(mesenchymal_obj$Compartment)


# Ensure 'orig.ident' has 'saline' first and '6OHDA' second
mesenchymal_obj$orig.ident <- factor(mesenchymal_obj$orig.ident, levels = c("saline", "6OHDA"))

# Step 1: Assign cluster Identity to full object
mesenchymal_obj$Mes_identity <- cluster_annotations$Identity[
  match(mesenchymal_obj$mes_cluster, cluster_annotations$ClusterID)
]

# Step 2: Balance cells across conditions (only for plotting)
min_cells <- min(table(mesenchymal_obj$orig.ident))

set.seed(42)
balanced_cells <- unlist(lapply(
  split(Cells(mesenchymal_obj), mesenchymal_obj$orig.ident),
  function(cells) sample(cells, min_cells)
))

# Step 3: Subset AFTER annotation is added
mesenchymal_obj_balanced <- subset(mesenchymal_obj, cells = balanced_cells)

# Step 4: Set cluster labels
Idents(mesenchymal_obj_balanced) <- mesenchymal_obj_balanced$Mes_identity

# UMAP split by condition, colored by new Compartment identities
DimPlot(
  mesenchymal_obj_balanced,
  reduction = "umap",
  group.by = "Compartment",  # Color by updated Compartment annotations
  split.by = "orig.ident",   # Split by saline vs 6OHDA
  label = FALSE,              # Show compartment labels
  label.size = 4,            # Label size
  pt.size = 1.0              # Dot size
) +
  ggtitle("Mesenchymal Cells by Compartment and Condition") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", size = 1),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, face = "bold"),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold")
  )

# UMAP orig.ident merged 
DimPlot(
  mesenchymal_obj_balanced,
  reduction = "umap",
  group.by = "orig.ident",  # Color by saline v 6ohda
  label = FALSE,              # Show compartment labels
  label.size = 4,            # Label size
  pt.size = 0.5              # Dot size
) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", size = 1),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, face = "bold"),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold")
  )


cat("‚úî Balanced mesenchymal cells saved in `mesenchymal_obj_balanced` and ready for UMAP visualization\n")



```

# UMAP orig.ident merged 
DimPlot(
  mesenchymal_obj_balanced,
  reduction = "umap",
  group.by = "orig.ident",  # Color by saline v 6ohda
  label = TRUE,              # Show compartment labels
  label.size = 4,            # Label size
  pt.size = 0.5              # Dot size
) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", size = 1),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, face = "bold"),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold")
  )

  

# UMAP split by condition, colored by new Compartment identities
DimPlot(
  mesenchymal_obj_balanced,
  reduction = "umap",
  group.by = "Compartment",  # Color by updated Compartment annotations
  split.by = "orig.ident",   # Split by saline vs 6OHDA
  label = FALSE,              # Show compartment labels
  label.size = 4,            # Label size
  pt.size = 1.0              # Dot size
) +
  ggtitle("Mesenchymal Cells by Compartment and Condition") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", size = 1),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, face = "bold"),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold")
  )
  
  
# UMAP merged, colored by new Compartment identities
DimPlot(
  mesenchymal_obj_balanced,
  reduction = "umap",
  group.by = "Compartment",  # Color by updated Compartment annotations
  label = FALSE,              # Show compartment labels
  label.size = 4,            # Label size
  pt.size = 1.0              # Dot size
) +
  ggtitle("Mesenchymal Clusters") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", size = 1),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, face = "bold"),
    axis.text.y = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold")
  )


library(ggplot2)
library(Seurat)

# Create UMAP plot with split by condition
p_umap <- DimPlot(
  mesenchymal_obj_balanced, 
  reduction = "umap", 
  group.by = "Compartment", 
  split.by = "orig.ident", 
  label = FALSE, 
  label.size = 4, 
  pt.size = 1.0
) +
  ggtitle("Mesenchymal Cells Colored by Compartment") +
  theme_minimal() +
  theme(
    plot.background = element_rect(fill = "transparent", color = NA),
    panel.background = element_rect(fill = "transparent", color = NA),
    legend.background = element_rect(fill = "transparent", color = NA),
    legend.key = element_rect(fill = "transparent", color = NA),

    panel.grid = element_blank(),
    axis.line = element_line(color = "white", size = 1),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, face = "bold", color = "white"),
    axis.text.y = element_text(size = 12, face = "bold", color = "white"),
    axis.title = element_text(size = 14, face = "bold", color = "white"),
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold", color = "white")
  )

#save transparent function
save_transparent_svg <- function(plot, filename, width = 6, height = 5) {
  ggsave(
    filename = filename,
    plot = plot,
    device = "svg",
    bg = "transparent",
    width = width,
    height = height,
    units = "in"
  )
}

# Save as SVG with transparent background
ggsave(
  filename = "umap_compartments_split.svg",
  plot = p_umap,
  device = "svg",
  width = 8, height = 6,
  bg = "transparent"
)

 
# Extract UMAP coordinates and the seurat_clusters from the metadata
umap_coords <- as.data.frame(Embeddings(mesenchymal_obj, reduction = "umap"))
umap_coords$cluster <- as.character(mesenchymal_obj$seurat_clusters)


# FeaturePlot for Ccl2, split by condition, colored by gene expression
FeaturePlot(
  mesenchymal_obj, 
  features = c("Ccl2"),  # Genes of interest
  reduction = "umap",  # Use UMAP for visualization
  split.by = "orig.ident",  # Split by condition (saline vs 6OHDA)
  cols = c("lightgrey", "firebrick"),  # Color scheme for expression
  label = FALSE,  # Add labels for clusters
) +
  ggtitle("Gene Expr") +
  theme_minimal()

## Bar chart 

```{r}

# Assuming `mesenchymal_obj` contains the metadata with 'Compartment' and 'orig.ident'
# Calculate the count of cells for each condition and compartment
cell_counts <- mesenchymal_obj@meta.data %>%
  group_by(orig.ident, Compartment) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(orig.ident) %>%
  mutate(frequency = count / sum(count) * 100)

# Calculate the total number of cells per condition
total_cells_per_condition <- cell_counts %>%
  group_by(orig.ident) %>%
  summarise(total_cells = sum(count))

# Merge and calculate frequency
cell_counts <- cell_counts %>%
  left_join(total_cells_per_condition, by = "orig.ident") %>%
  mutate(frequency = count / total_cells * 100)

# Reorder for plotting
cell_counts$orig.ident <- factor(cell_counts$orig.ident, levels = c("saline", "6OHDA"))

# Inspect the table
head(cell_counts)


# Reorder 'orig.ident' to have 'saline' first and '6OHDA' second
cell_counts$orig.ident <- factor(cell_counts$orig.ident, levels = c("saline", "6OHDA"))


```


# Plot the stacked bar chart with adjustments
ggplot(cell_counts, aes(x = orig.ident, y = frequency, fill = Compartment)) +
  geom_bar(stat = "identity", width = 0.4, color = "black") +  # Make bars more compact with smaller width
  scale_y_continuous(labels = scales::percent_format(scale = 1), expand = c(0, 0)) +  # Remove space between bars and y-axis
  scale_x_discrete(expand = c(0.5, 0)) +  # Small space between bars and x-axis (left side)
  labs(x = "Condition", y = "Frequency (%)", title = "Mesenchymal Cell Cluster Distribution") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, face = "bold"),  # Bold x-axis text
    axis.text.y = element_text(size = 12, face = "bold"),  # Bold y-axis text
    axis.title = element_text(size = 14, face = "bold"),  # Bold axis titles
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold"),  # Bold plot title
    legend.text = element_text(size = 12, face = "bold"),  # Bold legend text
    legend.title = element_text(size = 14, face = "bold"),  # Bold legend title
    panel.grid = element_blank(),  # Remove grid lines
    axis.line = element_line(color = "black", size = 1),  # Add black axis lines
    panel.spacing = unit(0, "lines")  # Remove space between plot and axes
  )

library(ggplot2)

# Build the plot
p_bar <- ggplot(cell_counts, aes(x = orig.ident, y = frequency, fill = Compartment)) +
  geom_bar(stat = "identity", width = 0.4, color = "black") +
  scale_y_continuous(labels = scales::percent_format(scale = 1), expand = c(0, 0)) +
  scale_x_discrete(expand = c(0.5, 0)) +
  labs(x = "Condition", y = "Frequency (%)", title = "Cell Type Distribution by Condition") +
  theme_minimal() +
  theme(
    plot.background = element_rect(fill = "transparent", color = NA),
    panel.background = element_rect(fill = "transparent", color = NA),
    legend.background = element_rect(fill = "transparent", color = NA),
    legend.key = element_rect(fill = "transparent", color = NA),
    
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, face = "bold", color = "white"),
    axis.text.y = element_text(size = 12, face = "bold", color = "white"),
    axis.title = element_text(size = 14, face = "bold", color = "white"),
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold", color = "white"),
    legend.text = element_text(size = 12, face = "bold", color = "white"),
    legend.title = element_text(size = 14, face = "bold", color = "white"),
    
    panel.grid = element_blank(),
    axis.line = element_line(color = "white", size = 1),
    panel.spacing = unit(0, "lines")
  )

# Save as SVG for transparent background support in Keynote
ggsave(
  filename = "barplot_transparent.svg",
  plot = p_bar,
  device = "svg",
  width = 6,
  height = 5
)

## Dot 

```{r}
table(mesenchymal_obj$Compartment)

# Define the list of top markers for each compartment (cell subtype)
markers_list <- list(
  Alveolar             = c("Adra1a", "Scube2"),
  Inflammatory        = c("Saa3", "Lcn2"),
  Fibrotic             = c("Cthrc1", "Spp1"),
  `Stress-activated`   = c("Esd", "Ftl1"),
  `Transitional-Myofib`= c("Neat1", "Taco1"),
  Adventitial          = c("Pi16", "Dcn"),
  `Adventitial-Immune` = c("Il33", "Cxcl13"),
  Perivascular         = c("Flt1", "Tek"),
  Peribronchial        = c("Hhip", "Wnt5a"),
  `Pericyte`      = c("Cox4i2"),
  Mesothelial       = c("Msln")
)


table(mesenchymal_obj$Compartment)



# Flatten the marker list (x-axis)
markers_order <- unlist(markers_list, use.names = FALSE)

# Set desired y-axis order
compartment_order <- names(markers_list)
mesenchymal_obj$Compartment <- factor(mesenchymal_obj$Compartment, levels = compartment_order)

table(mesenchymal_obj$Compartment)
mesenchymal_obj$Compartment <- droplevels(mesenchymal_obj$Compartment)

# Filter marker list to only genes present

# Generate DotPlot
DotPlot(
  mesenchymal_obj, 
  features = markers_order,
  group.by = "Compartment", 
  cols = c("lightgrey", "blue"), 
  dot.scale = 8,
  assay = "SCT"
) +
  ggtitle("Expression of Top Markers by Cell Subtype") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, face = "bold", color = "black"),
    axis.text.y = element_text(size = 12, face = "bold", color = "black", margin = margin(r = 10)),
    axis.title = element_text(size = 14, face = "bold", color = "black"),
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold", color = "black"),
    plot.margin = margin(10, 10, 10, 10),
    strip.background = element_blank(),
    strip.text = element_blank()
  )
table(mesenchymal_obj$Compartment, useNA = "ifany")
Idents(mesenchymal_obj) <- "seurat_clusters"
table(Idents(mesenchymal_obj), is.na(mesenchymal_obj$Compartment))

table(Idents(mesenchymal_obj))
levels(Idents(mesenchymal_obj))


soup_gene_table <- get0("soup_gene_table",
                        ifnotfound = data.frame(gene = character(), is_soup_like = logical()))

```

# Generate DotPlot
DotPlot(
  mesenchymal_obj, 
  features = markers_order,
  group.by = "Compartment", 
  cols = c("lightgrey", "blue"), 
  dot.scale = 8,
  assay = "SCT"
) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, face = "bold", color = "black"),
    axis.text.y = element_text(size = 12, face = "bold", color = "black", margin = margin(r = 10)),
    axis.title = element_text(size = 14, face = "bold", color = "black"),
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold", color = "black"),
    plot.margin = margin(10, 10, 10, 10),
    strip.background = element_blank(),
    strip.text = element_blank()
  )
  
# Create DotPlot with transparent background and white text
library(viridis)  # For viridis color palette

# Generate DotPlot
# Use a light-to-blue palette manually
custom_colors <- c("lightgrey", "#6BAED6")  # light grey to sky blue

# DotPlot
p_dot <- DotPlot(
  mesenchymal_obj,
  features = markers_order,
  group.by = "Compartment",
  cols = custom_colors,
  dot.scale = 8,
  assay = "SCT"
) +
  ggtitle("Expression of Top Markers by Cell Subtype") +
  theme_minimal() +
  theme(
    plot.background = element_rect(fill = "transparent", color = NA),
    panel.background = element_rect(fill = "transparent", color = NA),
    legend.background = element_rect(fill = "transparent", color = NA),
    legend.key = element_rect(fill = "transparent", color = NA),

    axis.text.x = element_text(angle = 45, hjust = 1, size = 12, face = "bold", color = "white"),
    axis.text.y = element_text(size = 12, face = "bold", color = "white"),
    axis.title = element_text(size = 14, face = "bold", color = "white"),
    plot.title = element_text(size = 16, hjust = 0.5, face = "bold", color = "white"),

    panel.grid = element_blank(),  # Remove gridlines
    strip.background = element_blank(),
    strip.text = element_blank(),
    plot.margin = margin(10, 10, 10, 10)
  )

# Save as transparent SVG
ggsave(
  filename = "dotplot_high_contrast_dark_bg.svg",
  plot = p_dot,
  device = "svg",
  width = 8,
  height = 3.5,
  bg = "transparent"
)



# Export to SVG with transparent background
ggsave(
  filename = "dotplot_transparent.svg",
  plot = p_dot,
  device = "svg",
  width = 8,
  height = 4,
  bg = "transparent"
)





## Including Plots

```{r}
#check output 
str(top_markers)
colnames(top_markers)
head(top_markers)
class(top_markers$cluster)
unique(top_markers$cluster)
attributes(top_markers)

dt <- as.data.table(top_markers)                 # convert once

annot_table <- dt[, .(
  Compartment                  = "Mesenchymal",
  Identify                     = gene[ which.max(avg_log2FC) ],
  `Top markers for cluster ID` = paste(gene, collapse = ", ")
), by = .(Cluster = cluster)]

annot_table

print(annot_table, n = 3)   # preview

```
## Comapre 6OHDA and saline DEGs per cluster 

```{r pressure, echo=FALSE}

condition_markers_list      <- list()  # filtered DEGs per cluster
condition_markers_all_list  <- list()  # all DEGs per cluster (for volcano etc.)

cluster_names <- unique(mesenchymal_obj$mes_cluster)

# quick check of sample composition + UMAP
table(mesenchymal_obj$orig.ident)
DimPlot(mesenchymal_obj, group.by = "orig.ident", reduction = "umap")

# define soup genes ONCE
soup_genes <- soup_gene_table$gene[isTRUE(soup_gene_table$is_soup_like)]

for (cl in cluster_names) {
  message("Processing cluster: ", cl)

  # Subset cluster
  subset_cluster <- subset(mesenchymal_obj, subset = mes_cluster == cl)
  condition_counts <- table(subset_cluster$orig.ident)

  # Run DE only if both conditions are present
  if (!all(c("6OHDA", "saline") %in% names(condition_counts))) {
    warning("Only one condition in cluster ", cl, "; storing NA.")
    condition_markers_list[[cl]]     <- NA
    condition_markers_all_list[[cl]] <- NA
    next
  }

  # Re-normalize with SCTransform per cluster
  DefaultAssay(subset_cluster) <- "RNA"
  subset_cluster[["SCT"]] <- NULL
  subset_cluster <- SCTransform(subset_cluster, verbose = FALSE)
  Idents(subset_cluster) <- "orig.ident"

  # logfc.threshold = 0 so we keep ALL genes and filter later
  markers_all <- FindMarkers(
    subset_cluster,
    ident.1         = "6OHDA",
    ident.2         = "saline",
    assay           = "SCT",
    slot            = "data",
    test.use        = "wilcox",
    min.pct         = 0.25,
    logfc.threshold = 0
  ) %>%
    rownames_to_column("gene") %>%
    mutate(
      p_val_adj = p.adjust(p_val, method = "fdr"),
      pct.diff  = pct.1 / pct.2,
      is_soup   = gene %in% soup_genes
    ) %>%
    # drop soup genes globally
    filter(!is_soup)

  # filtered list used for most downstream ‚Äúmarker‚Äù analyses
  markers_filtered <- markers_all %>%
    filter(
      p_val_adj < 0.05,
      abs(avg_log2FC) > 0.2    # visual/biological filter
    ) %>%
    arrange(desc(abs(pct.diff)))

  # Debugging info
  total_markers   <- nrow(markers_all)
  after_filtering <- nrow(markers_filtered)
  soup_removed    <- sum(markers_all$is_soup)

  cat("Cluster:", cl, "\n")
  cat("  ‚Üí Total markers:", total_markers, "\n")
  cat("  ‚Üí After filtering:", after_filtering, "\n")
  cat("  ‚Üí Soup genes removed:", soup_removed, "\n\n")

  # store both versions
  condition_markers_all_list[[cl]] <- markers_all
  condition_markers_list[[cl]]     <- markers_filtered
}


```

## Volcano Plot

```{r}

cluster_id  <- "Mes_0"
padj_cutoff <- 0.05   # FDR threshold
lfc_cutoff  <- 0.2    # visual/log2FC threshold

#-----------------------------
# 1. Pull DE results for Mes_0
#-----------------------------
degs_all <- condition_markers_all_list[[cluster_id]]

if (is.null(degs_all) || all(is.na(degs_all))) {
  stop("No DE results stored for cluster ", cluster_id,
       ". Check that both conditions are present in this cluster.")
}

# Optionally drop Sftpc specifically here
degs_all <- degs_all %>%
  filter(gene != "Sftpc") %>%
  mutate(
    neg_log10_padj = -log10(p_val_adj + 1e-300),
    category = case_when(
      p_val_adj < padj_cutoff & avg_log2FC <= -lfc_cutoff ~ "Up in saline",
      p_val_adj < padj_cutoff & avg_log2FC >=  lfc_cutoff ~ "Up in 6OHDA",
      TRUE                                                ~ "Not significant"
    )
  )

degs_plot <- degs_all  # for plotting & table

#-----------------------------
# 2. Interactive top-40 table
#-----------------------------
degs_table <- degs_plot %>%
  arrange(p_val_adj) %>%         # most significant first
  mutate(direction = category) %>%
  select(direction, gene, avg_log2FC, p_val_adj, everything())

top40_table <- head(degs_table, 40)

datatable(
  top40_table,
  rownames = FALSE,
  options  = list(
    pageLength = 10,
    scrollX    = TRUE
  ),
  caption  = "Top 40 DE genes in Mes_0 (6OHDA vs saline)"
)


#-----------------------------
# 3. Genes to highlight
#    (Sftpc removed from highlight list, since it's filtered out)
#-----------------------------
genes_to_highlight <- c(
  "Col1a1", "Timp1", "Spp1", "Fn1", "Serpina3n",
  "Col1a2", "Col4a2", "Sftpa1", "Gsn", "Fmo2"
)

highlight_df <- degs_plot %>%
  filter(gene %in% genes_to_highlight)

#-----------------------------
# 4. Volcano plot
#-----------------------------
ggplot(degs_plot, aes(x = avg_log2FC, y = neg_log10_padj)) +
  geom_point(aes(color = category), alpha = 0.8, size = 1.6) +
  geom_vline(xintercept = c(-lfc_cutoff, lfc_cutoff), linetype = "dashed") +
  geom_hline(yintercept = -log10(padj_cutoff), linetype = "dashed") +

  # Highlight and label your chosen genes
  geom_point(
    data  = highlight_df,
    aes(x = avg_log2FC, y = neg_log10_padj),
    size  = 3.5,
    shape = 21,
    color = "black"
  ) +
  geom_text_repel(
    data        = highlight_df,
    aes(label   = gene),
    size        = 3.2,
    fontface    = "bold",
    max.overlaps = 100
  ) +

  scale_color_manual(
    values = c(
      "Up in saline"    = "red",
      "Up in 6OHDA"     = "blue",
      "Not significant" = "grey70"
    )
  ) +
  labs(
    title = "Volcano plot ‚Äì Mes_0 (6OHDA vs saline)",
    x     = "avg_log2FC (6OHDA vs saline)",
    y     = "-log10(FDR-adjusted p-value)",
    color = "Status"
  ) +
  theme_classic()


```
#-----------------------------
# 4. Volcano plot
#-----------------------------
ggplot(degs_plot, aes(x = avg_log2FC, y = neg_log10_padj)) +
  geom_point(aes(color = category), alpha = 0.8, size = 1.6) +
  geom_vline(xintercept = c(-lfc_cutoff, lfc_cutoff), linetype = "dashed") +
  geom_hline(yintercept = -log10(padj_cutoff), linetype = "dashed") +

  # Highlight and label your chosen genes
  geom_point(
    data  = highlight_df,
    aes(x = avg_log2FC, y = neg_log10_padj),
    size  = 3.5,
    shape = 21,
    color = "black"
  ) +
  geom_text_repel(
    data        = highlight_df,
    aes(label   = gene),
    size        = 3.2,
    fontface    = "bold",
    max.overlaps = 100
  ) +

  scale_color_manual(
    values = c(
      "Up in saline"    = "red",
      "Up in 6OHDA"     = "blue",
      "Not significant" = "grey70"
    )
  ) +
  labs(
    title = "Volcano plot ‚Äì Mes_0 (6OHDA vs saline)",
    x     = "avg_log2FC",
    y     = "-log10 (adj. p)",
    color = "Status"
  ) +
  theme_classic()

#Indv. Violin Plots
```{r}
# =============================================================================
# Unified, assay-stable plotting block for Adra1a / Spp1 (violins + boxplots)
# Paste this as one chunk.
# =============================================================================

# ---- 0) Choose the assay used for ALL plots below ---------------------------
# Use "SCT" for SCTransform-normalized log data, or "RNA" for NormalizeData().
PLOT_ASSAY <- "SCT"    # <-- change to "RNA" if you prefer RNA-normalized values

# Ensure plotting pulls from this assay unless a function overrides via assay=
DefaultAssay(mesenchymal_obj) <- PLOT_ASSAY

# Keep identities consistent for group.by below
Idents(mesenchymal_obj) <- "Compartment"

# Ensure condition order for split/boxplots
mesenchymal_obj$orig.ident <- factor(mesenchymal_obj$orig.ident, levels = c("saline", "6OHDA"))

# ---- 1) Violin: Adra1a by Compartment --------------------------------------
p_vln_adra <- VlnPlot(
  mesenchymal_obj,
  features = "Adra1a",
  group.by = "Compartment",
  pt.size = 0.1,
  assay = PLOT_ASSAY
) +
  theme_minimal() +
  labs(title = "Adra1a Expression",
       y = sprintf("Expression (%s / data slot)", PLOT_ASSAY)) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, face = "bold", size = 12),
    axis.text.y = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 14),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent", color = NA),
    plot.background = element_rect(fill = "transparent", color = NA)
  )

# ---- 2) Violin: Spp1 by Compartment ----------------------------------------
p_vln_spp1 <- VlnPlot(
  mesenchymal_obj,
  features = "Spp1",
  group.by = "Compartment",
  pt.size = 0.1,
  assay = PLOT_ASSAY
) +
  theme_minimal() +
  labs(title = "Spp1 Expression",
       y = sprintf("Expression (%s / data slot)", PLOT_ASSAY)) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, face = "bold", size = 12),
    axis.text.y = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 14),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent", color = NA),
    plot.background = element_rect(fill = "transparent", color = NA)
  )

# ---- 3) Violin (dark/transparent variant): Adra1a ---------------------------
p_vln_adra_dark <- VlnPlot(
  mesenchymal_obj,
  features = "Adra1a",
  group.by = "Compartment",
  pt.size = 0.1,
  assay = PLOT_ASSAY
) +
  theme_minimal() +
  labs(title = "Adra1a Expression by Cell Compartment",
       y = sprintf("Expression (%s / data slot)", PLOT_ASSAY)) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16, color = "white"),
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, face = "bold", size = 12, color = "white"),
    axis.text.y = element_text(face = "bold", size = 12, color = "white"),
    axis.title.y = element_text(face = "bold", size = 14, color = "white"),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent", color = NA),
    plot.background = element_rect(fill = "transparent", color = NA),
    legend.text = element_text(color = "white"),
    legend.title = element_text(color = "white")
  )

# ---- 4) Split violins across all compartments: Spp1 (saline vs 6OHDA) ------
p_vln_spp1_split <- VlnPlot(
  object     = mesenchymal_obj,
  features   = "Spp1",
  group.by   = "Compartment",
  split.by   = "orig.ident",
  split.plot = TRUE,
  pt.size    = 0.1,
  assay      = PLOT_ASSAY,
  cols       = c("saline" = "#56B4E9", "6OHDA" = "#F8766D")
) +
  theme_minimal() +
  labs(title = "Spp1 Expression (Saline vs 6OHDA)",
       y = sprintf("Expression (%s / data slot)", PLOT_ASSAY)) +
  theme(
    plot.title       = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.title.x     = element_blank(),
    axis.text.x      = element_text(angle = 45, hjust = 1, face = "bold", size = 12),
    axis.text.y      = element_text(face = "bold", size = 12),
    axis.title.y     = element_text(face = "bold", size = 14),
    panel.grid       = element_blank(),
    panel.background = element_rect(fill = "white", colour = NA),
    plot.background  = element_rect(fill = "white", colour = NA),
    legend.title     = element_blank(),
    legend.text      = element_text(size = 12)
  )

# ---- 5a) Alveolar-only (Mes_0) split violins: Spp1 ---------------------------
alveolar_obj <- subset(mesenchymal_obj, subset = mes_cluster == "Mes_0")
DefaultAssay(alveolar_obj) <- PLOT_ASSAY
Idents(alveolar_obj) <- "Compartment"

p_vln_spp1_alv_split <- VlnPlot(
  object     = alveolar_obj,
  features   = "Spp1",
  group.by   = "Compartment",
  split.by   = "orig.ident",
  split.plot = FALSE,
  pt.size    = 0.1,
  assay      = PLOT_ASSAY,
  cols       = c("saline" = "#F8766D", "6OHDA" = "#56B4E9")
) +
  theme_minimal() +
  labs(title = "Spp1 Expression in Alveolar (Mes_0)",
       y = sprintf("Expression (log)", PLOT_ASSAY)) +
  theme(
    plot.title    = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text.x   = element_text(angle = 45, hjust = 1, size = 12),
    axis.text.y   = element_text(size = 12),
    axis.title.y  = element_text(size = 14)
  )


# ---- 6) Alveolar (Mes_0) boxplots: vertical + rotated ----------------------
# Fetch expression + metadata
df_alv <- FetchData(alveolar_obj, vars = c("Spp1", "Compartment", "orig.ident"))
colnames(df_alv) <- c("expression", "Compartment", "Condition")
df_alv$Cluster   <- "Alveolar (Mes_0)"
df_alv$Condition <- factor(df_alv$Condition, levels = c("saline", "6OHDA"))

p_box_vert <- ggplot(df_alv, aes(x = Cluster, y = expression, fill = Condition)) +
  geom_boxplot(outlier.size = 0.5, width = 0.6, position = position_dodge(width = 0.8)) +
  scale_fill_manual(values = c("saline" = "#FDB7B3", "6OHDA" = "#F8766D")) +
  labs(title = "Spp1 Expression",
       x = "Alveolar",
       y = sprintf("Expression (%s / data slot)", PLOT_ASSAY)) +
  theme_minimal() +
  theme(
    plot.title   = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text.x  = element_text(angle = 45, hjust = 1, size = 12),
    axis.text.y  = element_text(size = 12),
    axis.title.y = element_text(size = 14)
  )

p_box_rot <- ggplot(df_alv, aes(y = Condition, x = expression, fill = Condition)) +
  geom_boxplot(width = 0.5, outlier.shape = NA, position = position_dodge(width = 0.8)) +
  geom_jitter(aes(color = Condition),
              position = position_jitter(height = 0.15, width = 0),
              size = 1, alpha = 0.6, show.legend = FALSE) +
  scale_fill_manual(values = c("saline" = "#FDB7B3", "6OHDA" = "#F8766D")) +
  scale_color_manual(values = c("saline" = "grey80", "6OHDA" = "grey80")) +
  labs(title = "Spp1 Expression in Alveolar (Mes_0)",
       x = sprintf("Expression (%s / data slot)", PLOT_ASSAY),
       y = NULL) +
  theme_minimal() +
  theme(
    plot.title  = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.title.x= element_text(size = 14),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    panel.grid  = element_blank()
  )

# ---- 7) Print everything you want to see -----------------------------------
print(p_vln_adra)
print(p_vln_spp1)
print(p_vln_adra_dark)
print(p_vln_spp1_split)
print(p_vln_spp1_alv_split)
print(p_box_vert)
print(p_box_rot)

# ---- 8) (Optional) Lock axis ranges for consistent visuals ------------------
# Example limits; adjust to your data:
# p_vln_adra      <- p_vln_adra      + coord_cartesian(ylim = c(0, 4))
# p_vln_spp1      <- p_vln_spp1      + coord_cartesian(ylim = c(0, 4))
# p_vln_spp1_split<- p_vln_spp1_split+ coord_cartesian(ylim = c(0, 4))
# p_vln_spp1_alv_split <- p_vln_spp1_alv_split + coord_cartesian(ylim = c(0, 4))
# p_box_vert      <- p_box_vert      + coord_cartesian(ylim = c(0, 4))
# p_box_rot       <- p_box_rot       + coord_cartesian(xlim = c(0, 4))
# ggsave("spp1_box_vertical.svg", p_box_vert, width = 6, height = 4, bg = "transparent")
# ggsave("spp1_box_rotated.svg",  p_box_rot,  width = 6, height = 4, bg = "transparent")
# =============================================================================


```
# ---- 7) Print everything you want to see -----------------------------------
print(p_vln_adra)
print(p_vln_spp1)
print(p_vln_adra_dark)
print(p_vln_spp1_split)
print(p_vln_spp1_alv_split)
print(p_box_vert)
print(p_box_rot)

#---------------------------
# ---- 5b) Alveolar-only (Mes_0) split violins: Tgfb1 ---------------------------
alveolar_obj <- subset(mesenchymal_obj, subset = mes_cluster == "Mes_0")
DefaultAssay(alveolar_obj) <- PLOT_ASSAY
Idents(alveolar_obj) <- "Compartment"

p_vln_tgfb1_alv_split <- VlnPlot(
  object     = alveolar_obj,
  features   = "Tgfb1",
  group.by   = "Compartment",
  split.by   = "orig.ident",
  split.plot = FALSE,
  pt.size    = 0.1,
  assay      = PLOT_ASSAY,
  cols       = c("saline" = "#F8766D", "6OHDA" = "#56B4E9")
) +
  theme_minimal() +
  labs(
    title = "Tgfb1",
    y = "Expression (log)"
  ) +
  theme(
    plot.title    = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text.x   = element_text(angle = 45, hjust = 1, size = 12),
    axis.text.y   = element_text(size = 12),
    axis.title.y  = element_text(size = 14)
  )

# üî• THIS LINE ACTUALLY DISPLAYS THE TGFB1 PLOT üî•
p_vln_tgfb1_alv_split


# ---- 5b) Alveolar-only (Mes_0) split violins: Acta2 ---------------------------
alveolar_obj <- subset(mesenchymal_obj, subset = mes_cluster == "Mes_0")
DefaultAssay(alveolar_obj) <- PLOT_ASSAY
Idents(alveolar_obj) <- "Compartment"

p_vln_acta2_alv_split <- VlnPlot(
  object     = alveolar_obj,
  features   = "Acta2",
  group.by   = "Compartment",
  split.by   = "orig.ident",
  split.plot = FALSE,
  pt.size    = 0.1,
  assay      = PLOT_ASSAY,
  cols       = c("saline" = "#F8766D", "6OHDA" = "#56B4E9")
) +
  theme_minimal() +
  labs(
    title = "Acta2",
    y = "Expression"
  ) +
  theme(
    plot.title    = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text.x   = element_text(angle = 45, hjust = 1, size = 12),
    axis.text.y   = element_text(size = 12),
    axis.title.y  = element_text(size = 14)
  )

# üî• THIS LINE ACTUALLY DISPLAYS THE TGFB1 PLOT üî•
p_vln_acta2_alv_split

#ADRA1a-----------------------
# Create violin plot
VlnPlot(
  mesenchymal_obj,
  features = "Adra1a",
  group.by = "Compartment",
  pt.size = 0.1,        # Smaller points for visibility
  assay = "SCT"         # Or "RNA" depending on where Adra1a is
) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, face = "bold", size = 12),
    axis.text.y = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 14),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "transparent", color = NA),
    plot.background = element_rect(fill = "transparent", color = NA)
  ) +
  labs(title = "Adra1a Expression", y = "Expression (log)")


# Save as transparent SVG
ggsave("adra1a_violin_transparent.svg", plot = p, width = 6, height = 4, bg = "transparent")


# Optional PNG fallback:
# ggsave("adra1a_violin_transparent.png", plot = p, width = 6, height = 5, bg = "transparent", dpi = 300)


# Subset Alveolar cluster (Mes_0)
alveolar_obj <- subset(mesenchymal_obj, subset = mes_cluster == "Mes_0")

# Fetch expression + metadata
df <- FetchData(
  alveolar_obj,
  vars = c("Spp1", "orig.ident")
)
colnames(df) <- c("expression", "Condition")

# Ensure "saline" is on top by setting factor levels
df$Condition <- factor(df$Condition, levels = c("6OHDA", "saline"))

# Plot rotated boxplot
ggplot(df, aes(y = Condition, x = expression, fill = Condition)) +
  geom_boxplot(
    width = 0.5,
    outlier.shape = NA,
    position = position_dodge(width = 0.8)
  ) +
  geom_jitter(
    aes(color = Condition),
    position = position_jitter(height = 0.15, width = 0),
    size = 1,
    alpha = 0.6,
    show.legend = FALSE
  ) +
  scale_fill_manual(values = c("saline" = "#F8766D", "6OHDA" = "#FBB4B9")) +
  scale_color_manual(values = c("saline" = "grey80", "6OHDA" = "grey80")) +
  labs(
    title = "Spp1 Expression in Alveolar Subpopulation",
    x = "Expression (log-normalized)",
    y = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title       = element_text(hjust = 0.5, face = "bold", size = 16, colour = "white"),
    axis.title.x     = element_text(colour = "white", size = 14),
    axis.text.x      = element_text(size = 12, colour = "white"),
    axis.text.y      = element_text(size = 12, colour = "white"),
    panel.grid       = element_blank(),
    panel.background = element_rect(fill = "transparent", colour = NA),
    plot.background  = element_rect(fill = "transparent", colour = NA),
    legend.title     = element_blank(),
    legend.text      = element_text(colour = "white"),
    legend.background = element_rect(fill = "transparent", colour = NA)
  )


#open if starting here

# Define path
save_path <- "/Users/beckysalamon/Desktop/saline-6ohda-scrna-seq/RDS_object/mesenchymal_DEG_bundle.rds"

# Load RDS object
degs <- readRDS("/Users/beckysalamon/Desktop/saline-6ohda-scrna-seq/RDS_object/mes_DEG_file.rds")
ranked <- readRDS("/Users/beckysalamon/Desktop/saline-6ohda-scrna-seq/RDS_object/mes_ranked_genes.rds")



# Save full DEG dataframe (with p-values, logFC, etc.)
saveRDS(degs, file = "/Users/beckysalamon/Desktop/saline-6ohda-scrna-seq/RDS_object/mes_DEG_file.rds")

# Optionally save just the ranked vector used for GSEA
saveRDS(ranked, file = "/Users/beckysalamon/Desktop/saline-6ohda-scrna-seq/RDS_object/mes_ranked_genes.rds")



## DEG Pathway Analysis
```{r}

cluster_id <- "Mes_0"   # change as needed

degs_all <- condition_markers_list[[cluster_id]]

# Harmonize column names across Seurat versions
fc_col   <- intersect(c("avg_log2FC","avg_logFC","log2FC","logFC"), names(degs_all))[1]
pct1_col <- intersect(c("pct.1","pct1","pct_1"), names(degs_all))[1]
pct2_col <- intersect(c("pct.2","pct2","pct_2"), names(degs_all))[1]
if (is.na(fc_col)) stop("No logFC column found in DEGs for enrichment.")

# Up in saline (negative if ident.1 = 6OHDA, ident.2 = saline)
degs <- degs_all %>% dplyr::filter(.data[[fc_col]] < 0)

# Optional: require saline expression not too low vs 6OHDA
if (!is.na(pct1_col) && !is.na(pct2_col)) {
  degs <- degs %>%
    dplyr::mutate(pct.ratio = (.data[[pct1_col]] + 1e-5) / (.data[[pct2_col]] + 1e-5)) %>%
    dplyr::filter(pct.ratio <= 0.71)
}

cat("Genes passing filter:", nrow(degs), "\n")

# Map SYMBOL -> ENTREZ
if (!"gene" %in% names(degs)) degs <- tibble::rownames_to_column(degs, "gene")
gene_map <- bitr(degs$gene, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Mm.eg.db)
degs <- inner_join(degs, gene_map, by = c("gene" = "SYMBOL"))
stopifnot(nrow(degs) > 0)

# Reactome ORA
e_react <- enrichPathway(
  gene          = degs$ENTREZID,
  organism      = "mouse",
  pvalueCutoff  = 1,
  qvalueCutoff  = 1,
  pAdjustMethod = "BH"
)

if (!is.null(e_react) && nrow(e_react@result) > 0) {
  print(dotplot(e_react, showCategory = min(20, nrow(e_react@result))) +
          ggtitle(paste0("Reactome ORA ‚Äì Up in Saline (", cluster_id, ")")))
} else {
  message("No Reactome enrichment; trying GO:BP")
  ego_bp <- enrichGO(gene = degs$ENTREZID, OrgDb = org.Mm.eg.db,
                     keyType = "ENTREZID", ont = "BP", pvalueCutoff = 0.05)
  if (!is.null(ego_bp) && nrow(ego_bp@result) > 0) {
    print(dotplot(ego_bp, showCategory = min(20, nrow(ego_bp@result))) +
            ggtitle(paste0("GO BP ‚Äì Up in Saline (", cluster_id, ")")))
  } else {
    message("No GO enrichment either.")
  }
}


```
# ----------------------------
# 5. Visualization
# ----------------------------
print(
  dotplot(e_react, showCategory = min(10, nrow(e_react@result))) +
  ggtitle(paste0("Reactome ORA ‚Äì Up in Saline (", cluster_id, ")"))
)

  # ----------------------------
# 6. Interactive Enrichment Table
# ----------------------------
if (!is.null(e_react) && nrow(e_react@result) > 0) {
  datatable(
    e_react@result %>%
      select(ID, Description, GeneRatio, BgRatio, pvalue, p.adjust, qvalue, geneID),
    options = list(pageLength = 10, scrollX = TRUE),
    caption = paste("Reactome enrichment ‚Äì Upregulated in Saline (", cluster_id, ")")
  )
}
nrow(degs)
head(gene_map)
setdiff(degs$gene, gene_map$SYMBOL)

## Write Excel for top DEGs between conditions 

```{r}
# Step 9 ‚Äî Excel export of FILTERED DEGs (skip empty clusters)

wb <- openxlsx::createWorkbook()

for (clust in names(condition_markers_list)) {
  df <- condition_markers_list[[clust]]

  # skip clusters with no filtered DEGs
  if (!is.data.frame(df) || !nrow(df)) {
    message("Skipping cluster ", clust, ": no filtered DEGs.")
    next
  }

  # make sure gene column exists (should already from upstream code)
  if (!"gene" %in% names(df)) {
    df <- tibble::rownames_to_column(df, "gene")
  }

  # pick the logFC column actually present
  fc_col <- intersect(
    c("avg_log2FC", "avg_logFC", "log2FC", "logFC"),
    names(df)
  )[1]

  df <- df %>%
    mutate(
      Cluster   = clust,
      Direction = dplyr::case_when(
        .data[[fc_col]] > 0 ~ "Up in 6OHDA",
        .data[[fc_col]] < 0 ~ "Up in saline",
        TRUE                ~ "No change"
      )
    ) %>%
    # add annotation per cluster (ClusterID should match 'Cluster')
    left_join(cluster_annotations, by = c("Cluster" = "ClusterID")) %>%
    relocate(
      Cluster, Compartment, Identity, Direction,
      gene, all_of(fc_col),
      .before = dplyr::everything()
    )

  # Excel sheet name (<= 31 chars)
  sheet_name <- substr(paste0("DEG_", clust), 1, 31)
  openxlsx::addWorksheet(wb, sheet_name)
  openxlsx::writeData(wb, sheet = sheet_name, df)
}

openxlsx::saveWorkbook(
  wb,
  "/Users/beckysalamon/Desktop/saline-6ohda-scrna-seq/excel/Filtered_6OHDA_vs_saline_DEGs_by_cluster.xlsx",
  overwrite = TRUE
)

cat("‚úî Filtered and annotated DEGs exported successfully.\n")


```

##Heatmap
```{r}
# =============================================================================
# Pathway‚Üígene heatmap for a cluster (averaged expression by condition)
# Requirements: e_react from enrichPathway(), condition_markers_list, mesenchymal_obj
# =============================================================================

# ---- settings ----------------------------------------------------------------
cluster_id  <- "Mes_0"     # change if needed
PLOT_ASSAY  <- "SCT"       # "SCT" or "RNA"
TOP_PATHS   <- 8           # how many top Reactome pathways to visualize
MAX_GENES   <- 50          # cap total unique genes in the heatmap (keeps it readable)

# ---- prep: get DEGs for direction/context -----------------------------------
degs_all <- condition_markers_list[[cluster_id]]
if (is.null(degs_all) || !nrow(degs_all)) stop("No DEGs found for cluster: ", cluster_id)

# Pick an fc column present in your table
fc_col <- intersect(c("avg_log2FC","avg_logFC","log2FC","logFC"), names(degs_all))[1]
if (is.na(fc_col)) stop("No logFC column found in DEGs.")

# Create a logFC named vector for later coloring/selection
fc_vec <- degs_all[[fc_col]]
names(fc_vec) <- if ("gene" %in% names(degs_all)) degs_all$gene else rownames(degs_all)

# ---- extract top pathways + gene symbols ------------------------------------
if (is.null(e_react) || nrow(e_react@result) == 0) stop("e_react has no pathways.")
e_tbl <- e_react@result %>% arrange(p.adjust) %>% head(TOP_PATHS)

# geneID column is "ENTREZ1/ENTREZ2/..."
genes_long <- e_tbl %>%
  transmute(Pathway = Description,
            ENTREZID = strsplit(geneID, "/")) %>%
  tidyr::unnest(ENTREZID)

# map ENTREZ ‚Üí SYMBOL
sym_map <- clusterProfiler::bitr(unique(genes_long$ENTREZID),
                                 fromType = "ENTREZID", toType = "SYMBOL",
                                 OrgDb = org.Mm.eg.db)
genes_long <- genes_long %>% left_join(sym_map, by = "ENTREZID") %>% filter(!is.na(SYMBOL))

# (optional) prioritize most changing genes per pathway by |logFC|
genes_long <- genes_long %>%
  mutate(abs_fc = abs(fc_vec[SYMBOL])) %>%
  group_by(Pathway) %>% slice_max(order_by = abs_fc, n = 8, with_ties = FALSE) %>% ungroup()

# limit total gene count
sel_genes <- genes_long %>% distinct(SYMBOL) %>% pull(SYMBOL)
if (length(sel_genes) > MAX_GENES) sel_genes <- sel_genes[seq_len(MAX_GENES)]

# row annotation: primary pathway membership (first hit per gene)
row_annot <- genes_long %>%
  filter(SYMBOL %in% sel_genes) %>%
  group_by(SYMBOL) %>% slice_min(order_by = match(Pathway, e_tbl$Description), n = 1) %>% ungroup() %>%
  select(Gene = SYMBOL, Pathway)

row_annot_df <- as.data.frame(row_annot)
row_annot_df <- tibble::column_to_rownames(row_annot_df, "Gene")

# ---- build averaged expression matrix (saline vs 6OHDA) ---------------------
# Subset to the cluster and set consistent assay
obj_cl <- subset(mesenchymal_obj, subset = mes_cluster == cluster_id)
DefaultAssay(obj_cl) <- PLOT_ASSAY

# group means by condition
obj_cl$Condition <- factor(obj_cl$orig.ident, levels = c("saline","6OHDA"))
Idents(obj_cl) <- "Condition"

avg_list <- Seurat::AverageExpression(obj_cl, assays = PLOT_ASSAY, slot = "data", group.by = "Condition")
avg_mat  <- avg_list[[PLOT_ASSAY]]  # genes x conditions
colnames(avg_mat)[colnames(avg_mat) == "g6OHDA"] <- "6OHDA"


# keep selected genes that exist in the matrix
sel_genes <- intersect(sel_genes, rownames(avg_mat))
if (length(sel_genes) < 2) stop("Too few selected genes available in expression matrix.")

mat <- avg_mat[sel_genes, c("saline","6OHDA"), drop = FALSE]

# z-score across rows for visualization
mat_z <- t(scale(t(as.matrix(mat))))
mat_z[is.na(mat_z)] <- 0

# order rows by pathway then by abs FC
ord <- row_annot %>%
  filter(Gene %in% rownames(mat_z)) %>%
  mutate(abs_fc = abs(fc_vec[Gene])) %>%
  arrange(factor(Pathway, levels = e_tbl$Description), desc(abs_fc)) %>%
  pull(Gene)
mat_z <- mat_z[ord, , drop = FALSE]
row_annot_df <- row_annot_df[ord, , drop = FALSE]

# ---- draw heatmap -----------------------------------------------------------
pheatmap::pheatmap(
  mat_z,
  cluster_rows = FALSE,
  cluster_cols = FALSE,
  annotation_row = row_annot_df,
  show_rownames = TRUE,
  show_colnames = TRUE,
  main = paste0("Top Reactome Pathways ‚Äì ", cluster_id, " (", PLOT_ASSAY, " / data; row z-score)"),
  angle_col = 0,
  fontsize_row = 8,
  border_color = NA
)
# =============================================================================

```
# ---- draw heatmap -----------------------------------------------------------
pheatmap::pheatmap(
  mat_z,
  cluster_rows = FALSE,
  cluster_cols = FALSE,
  annotation_row = row_annot_df,
  show_rownames = TRUE,
  show_colnames = TRUE,
  main = paste0("Top Reactome Pathways ‚Äì ", cluster_id, " (", PLOT_ASSAY, " / data; row z-score)"),
  angle_col = 0,
  fontsize_row = 8,
  border_color = NA
)
## Top biomarkers

```{r}
# ----------------------------
# 1. Set your cluster and pathway
# ----------------------------
cluster_id <- "Mes_0"                        # Change as needed
pathway_id <- "R-MMU-1474244"                # Reactome ECM pathway

# ----------------------------
# 2. Extract pathway gene IDs from Reactome result
# ----------------------------
pathway_gene_ids <- strsplit(
  e_react@result$geneID[which(e_react@result$ID == pathway_id)],
  "/"
)[[1]]

# ----------------------------
# 3. Map ENTREZ ‚Üí SYMBOL
# ----------------------------
pathway_gene_symbols <- bitr(
  pathway_gene_ids,
  fromType = "ENTREZID",
  toType   = "SYMBOL",
  OrgDb    = org.Mm.eg.db
)

# ----------------------------
# 4. Safely load DEGs for the selected cluster
# ----------------------------
deg_fc <- condition_markers_list[[cluster_id]]

# Only add rownames if "gene" isn't already a column
if (!"gene" %in% colnames(deg_fc)) {
  deg_fc <- deg_fc %>% rownames_to_column("gene")
}

# ----------------------------
# 5. Filter DEGs for upregulated in saline
# ----------------------------
deg_fc_saline <- deg_fc %>%
  filter(avg_log2FC < -0.2)  # Adjust logFC cutoff as desired

# ----------------------------
# 6. Intersect with pathway gene symbols and rank
# ----------------------------
top_pathway_genes <- deg_fc_saline %>%
  inner_join(pathway_gene_symbols, by = c("gene" = "SYMBOL")) %>%
  arrange(avg_log2FC)  # Most negative = strongest saline marker

# ----------------------------
# 7. View prioritized genes
# ----------------------------
top_pathway_genes %>%
  dplyr::select(gene, avg_log2FC, p_val_adj) %>%
  head(40)


```


## Save mes object  

```{r}
# Save Seurat object to file
saveRDS(merged_obj, file = "/Users/beckysalamon/Desktop/saline-6ohda-scrna-seq/RDS_object/seurat_obj_mesenchymal_subset.rds")
```

# Define fibrosis genes linked to ADRA1A signaling
fibrosis_genes <- c(
  "Spp1", "Col12a1", "Adra1a", "Saa3", "Ccl2"
)

# Define mapping (ClusterID should match Idents or seurat_clusters)
cluster_annotations <- data.frame(
  ClusterID   = paste0("Mes_", 0:10),
  Compartment = rep("Mesenchymal", 11),
  Identity    = c("Alveolar", "Fibrotic", "Transitional-Myofib", "Stress-activated",
                  "Adventitial", "Inflammatory", "Adventitial-Immune", "Perivascular",
                  "Peribronchial", "Mesothelial", "Pericyte")
)

table(mesenchymal_obj$Compartment)

# Then plot
DotPlot(mesenchymal_obj, features = fibrosis_genes_filtered, group.by = "Compartment",
        cols = c("lightgrey", "blue"), dot.scale = 8, assay = "SCT") +
  ggtitle("Fibrosis-Associated Gene Expression") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = "bold"),
    axis.text.y = element_text(size = 10, face = "bold"),
    plot.title = element_text(size = 14, hjust = 0.5, face = "bold")
  )

# Generate DotPlot
DotPlot(mesenchymal_obj, features = fibrosis_genes, group.by = "Compartment",
        cols = c("lightgrey", "blue"), dot.scale = 8, assay = "SCT") +
  ggtitle("Fibrosis-Associated Gene Expression") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10, face = "bold"),
    axis.text.y = element_text(size = 10, face = "bold"),
    plot.title = element_text(size = 14, hjust = 0.5, face = "bold")
  )
  
  # FeaturePlot for top candidates on UMAP
FeaturePlot(
  object     = mesenchymal_obj,
  features   = c("Adra1a", "Saa3", "Cthrc1"),
  reduction  = "umap",                  # or "tsne" if that's your default
  cols       = c("lightgrey", "red"),
  pt.size    = 0.8,
  combine    = TRUE,
  order      = TRUE                    # moved outside and no trailing comma
)
#----------------
# Split DotPlot by Treatment (Saline vs 6OHDA)
DotPlot(
  object    = mesenchymal_obj,
  features  = fibrosis_genes,
  group.by = "Compartment",
  split.by = "Treatment",                  # <- This enables splitting
  cols     = c("lightgrey", "blue"),
  dot.scale = 8,
  assay     = "SCT"
) +
  ggtitle("Fibrosis Gene Expression by Compartment (Split by Treatment)") +
  theme_minimal() +
  theme(
    axis.text.x  = element_text(angle = 45, hjust = 1, size = 10, face = "bold"),
    axis.text.y  = element_text(size = 10, face = "bold"),
    plot.title   = element_text(size = 14, hjust = 0.5, face = "bold")
  )


# Inspect what values exist in orig.ident
table(mesenchymal_obj$orig.ident)

# Create a Treatment column from orig.ident
mesenchymal_obj$Treatment <- case_when(
  mesenchymal_obj$orig.ident %in% c("Saline", "saline", "Saline_rep") ~ "Saline",
  mesenchymal_obj$orig.ident %in% c("6OHDA", "6ohda", "6OHDA_rep") ~ "6OHDA",
  TRUE ~ NA_character_
)

# Set Treatment as a factor with the correct order
mesenchymal_obj$Treatment <- factor(mesenchymal_obj$Treatment, levels = c("Saline", "6OHDA"))

# Confirm it worked
table(mesenchymal_obj$Treatment, useNA = "ifany")

# Make sure Treatment is a factor with the correct order
mesenchymal_obj$Treatment <- factor(mesenchymal_obj$Treatment, levels = c("Saline", "6OHDA"))

# Make sure Compartment is ordered
mesenchymal_obj$Compartment <- factor(
  mesenchymal_obj$Compartment,
  levels = c("Alveolar", "Inflammatory", "Fibrotic", "Transitional-Myofib",
             "Stress-activated", "Adventitial", "Immune-int",
             "Perivascular", "Peribronchial", "Smooth.Muscle", "Mesothelial")
)

# Set the cell identity to Compartment
Idents(mesenchymal_obj) <- "Compartment"

# Split violin plot for Spp1, Spp1, and Tgfb1 by treatment
VlnPlot(
  object     = mesenchymal_obj,
  features   = c("Spp1"),
  group.by   = "Compartment",
  split.by   = "orig.ident",
  split.plot = TRUE,
  pt.size    = 0.1,
  assay      = "SCT",
  log = TRUE,
  cols       = c("saline" = "#1f77b4",   # deeper blue
                 "6OHDA"  = "#d62728")   # richer red
) +
  theme_minimal() +
  theme(
    plot.title       = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.title.x     = element_blank(),
    axis.text.x      = element_text(angle = 45, hjust = 1, face = "bold", size = 12),
    axis.text.y      = element_text(face = "bold", size = 12),
    axis.title.y     = element_text(face = "bold", size = 14),
    panel.grid       = element_blank(),
    panel.background = element_rect(fill = "white", colour = NA),
    plot.background  = element_rect(fill = "white", colour = NA),
    legend.title     = element_blank(),
    legend.text      = element_text(size = 12)
  ) +
  labs(
    title = "Spp1 Expression",
    y     = "Expression (log-normalized)"
  )

